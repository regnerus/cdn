rangy.createModule("Coordinates",function(k,e){k.requireModules(["WrappedSelection","WrappedRange"]);var f="number";var c=k.WrappedRange;var g=k.dom,h=k.util;function i(s){var n=0,u=0;if(typeof s.pageXOffset==f&&typeof s.pageYOffset==f){n=s.pageXOffset;u=s.pageYOffset}else{var r=s.document;var t=r.documentElement;var p=r.compatMode;var q=(typeof p=="string"&&p.indexOf("CSS")>=0&&t)?t:g.getBody(r);if(q&&typeof q.scrollLeft==f&&typeof q.scrollTop==f){try{n=q.scrollLeft;u=q.scrollTop}catch(o){}}}return{x:n,y:u}}function b(o,n){n=n.toLowerCase();while(o){if(o.nodeType==1&&o.tagName.toLowerCase()==n){return o}o=o.parentNode}return null}function d(q,o,n,p){this.top=q;this.right=o;this.bottom=n;this.left=p;this.width=o-p;this.height=n-q}function l(p,o,n){return new d(p.top+n,p.right+o,p.bottom+n,p.left+o)}function a(n){return function(){var p=this["get"+(n?"Start":"End")+"ClientPos"]();var o=i(g.getWindow(this.startContainer));return{x:p.x+o.x,y:p.y+o.y}}}function m(s,t){var v=0,u=0;var o=t.documentElement,q=g.getBody(t);var n=(o.clientWidth===0&&typeof q.clientTop==f)?q:o;var r=n.clientLeft,p=n.clientTop;if(r){v=-r}if(p){u=-p}return l(s,v,u)}function j(o){var t=[],u=[],s=[],r=[];for(var p=0,n=o.length,q;p<n;++p){q=o[p];if(q){t.push(q.top);u.push(q.bottom);s.push(q.left);r.push(q.right)}}return new d(Math.min.apply(Math,t),Math.max.apply(Math,r),Math.max.apply(Math,u),Math.min.apply(Math,s))}(function(){var v=document.createElement("span");var n=h.isHostMethod(v,"getBoundingClientRect");v=null;var o=false,q=false;if(k.features.implementsDomRange){var t=k.createNativeRange();o=h.isHostMethod(t,"getClientRects");q=h.isHostMethod(t,"getBoundingClientRect");t.detach()}h.extend(k.features,{rangeSupportsGetBoundingClientRect:q,rangeSupportsGetClientRects:o,elementSupportsGetBoundingClientRect:n});var x=function(y){return function(){var A=this.cloneRange();A.collapse(y);var z=A.getBoundingClientRect();return{x:z[y?"left":"right"],y:z[y?"top":"bottom"]}}};var r=k.rangePrototype;if(k.features.implementsTextRange&&n){r.getBoundingClientRect=function(){var J=c.rangeToTextRange(this);var I=this.getNodes([1],function(K){return/^t[dh]$/i.test(K.tagName)});var B,E=[];if(I.length>0){var F=b(this.startContainer,"table");for(var z=0,D,A,H,y,G;D=I[z];++z){H=b(D,"table");if(!F||H!=F){y=this.cloneRange();if(F){y.setStartAfter(F)}y.setEndBefore(H);E.push(c.rangeToTextRange(y).getBoundingClientRect())}if(this.containsNode(D)){E.push(D.getBoundingClientRect())}else{A=J.duplicate();A.moveToElementText(D);if(A.compareEndPoints("StartToStart",J)==-1){A.setEndPoint("StartToStart",J)}else{if(A.compareEndPoints("EndToEnd",J)==1){A.setEndPoint("EndToEnd",J)}}E.push(A.getBoundingClientRect())}F=H}var C=b(this.endContainer,"table");if(!C&&F){y=this.cloneRange();y.setStartAfter(F);E.push(c.rangeToTextRange(y).getBoundingClientRect())}B=j(E)}else{B=J.getBoundingClientRect()}return m(B,g.getDocument(this.startContainer))}}else{if(k.features.implementsDomRange){var w=function(y){return(y instanceof c)?y:new c(y)};if(q){r.getBoundingClientRect=function(){var z=w(this).nativeRange;var y=z.getBoundingClientRect()||z.getClientRects()[0];return m(y,g.getDocument(this.startContainer))};if(o){var p=function(z,A){var y=z.childNodes};x=function(y){return function(){var A,B=w(this).nativeRange;var z=B.getClientRects();if(z.length==0&&n){if(y){}console.log(B,B.getClientRects(),B.getBoundingClientRect());if(this.collapsed&&this.startContainer.nodeType==1&&this.startOffset<this.startContainer.childNodes.length){var C=this.startContainer.childNodes[this.startOffset];if(C.getClientRects){console.log(C,C.getClientRects(),this.startContainer.getClientRects())}}}if(z.length>0){if(y){A=z[0];return{x:A.left,y:A.top}}else{A=z[z.length-1];return{x:A.right,y:A.bottom}}}else{throw e.createError("Cannot get position for range "+this.inspect())}}}}}else{var s=n?function(y){return m(y.getBoundingClientRect(),g.getDocument(y))}:function(C){var A=0,E=0,D=C,B=C.offsetWidth,z=C.offsetHeight;while(D){A+=D.offsetLeft;E+=D.offsetTop;D=D.offsetParent}return m(new d(E,A+B,E+z,A),g.getDocument(C))};var u=function(A){var D;A.splitBoundaries();var E=document.createElement("span");if(A.collapsed){A.insertNode(E);D=s(E);E.parentNode.removeChild(E)}else{var G=A.cloneRange();G.collapse(true);G.insertNode(E);var C=s(E);E.parentNode.removeChild(E);G.collapseToPoint(A.endContainer,A.endOffset);G.insertNode(E);var H=s(E);E.parentNode.removeChild(E);var F=[C,H];var y=A.getNodes([1],function(I){return A.containsNode(I)});for(var z=0,B=y.length;z<B;++z){F.push(s(y[z]))}D=j(F)}A.normalizeBoundaries();return D};r.getBoundingClientRect=function(y){return u(w(y))}}}}h.extend(r,{getBoundingDocumentRect:function(){var y=i(g.getWindow(this.startContainer));return l(this.getBoundingClientRect(),y.x,y.y)},getStartClientPos:x(true),getEndClientPos:x(false),getStartDocumentPos:a(true),getEndDocumentPos:a(false)})})();(function(){function n(r,q){return r.compareBoundaryPoints(q.START_TO_START,q)}function o(q){return function(){var v="getBounding"+(q?"Document":"Client")+"Rect";var s=[];for(var t=0,u=null,r;t<this.rangeCount;++t){s.push(this.getRangeAt(t)[v]())}return j(s)}}function p(q,r){return function(){if(this.rangeCount==0){return null}var t=r?"Document":"Client";var s=this.getAllRanges();if(s.length>1){s.sort(n)}return q?s[0]["getStart"+t+"Pos"]():s[s.length-1]["getEnd"+t+"Pos"]()}}h.extend(k.selectionPrototype,{getBoundingClientRect:o(false),getBoundingDocumentRect:o(true),getStartClientPos:p(true,false),getEndClientPos:p(false,false),getStartDocumentPos:p(true,true),getEndDocumentPos:p(false,true)})})()});