rangy.createModule("TextCommands",function(p,b){p.requireModules(["WrappedSelection","WrappedRange"]);var w=p.dom;var g=log4javascript.getLogger("rangy.textcommands");var c="span",k="boolean",s="undefined";function u(y){return y.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function a(z,y){return z.className&&new RegExp("(?:^|\\s)"+y+"(?:\\s|$)").test(z.className)}function j(z,y){if(z.className){if(!a(z,y)){z.className+=" "+y}}else{z.className=y}}var o=(function(){function y(z,A,B){return(A&&B)?" ":""}return function(A,z){if(A.className){A.className=A.className.replace(new RegExp("(?:^|\\s)"+z+"(?:\\s|$)"),y)}}})();function i(y){return y.className.split(/\s+/).sort().join(" ")}function t(z,y){return i(z)==i(y)}function e(z){var y=z.parentNode;while(z.hasChildNodes()){y.insertBefore(z.firstChild,z)}y.removeChild(z)}function d(E,C){if(E.attributes.length!=C.attributes.length){return false}for(var D=0,y=E.attributes.length,B,z,A;D<y;++D){B=E.attributes[D];A=B.name;if(A!="class"){z=C.attributes.getNamedItem(A);if(B.specified!=z.specified){return false}if(B.specified&&B.nodeValue!==z.nodeValue){return false}}}return true}function f(A){for(var z=0,y=A.attributes.length;z<y;++z){if(A.attributes[z].specified&&A.attributes[z].name!="class"){return true}}return false}function v(y,z){if(w.isCharacterDataNode(y)){if(z==0){return !!y.previousSibling}else{if(z==y.length){return !!y.nextSibling}else{return true}}}return z>0&&z<y.childNodes.length}function r(B,z,A){g.debug("splitNodeAt",w.inspectNode(B),w.inspectNode(z),A);var y;if(w.isCharacterDataNode(z)){if(A==0){A=w.getNodeIndex(z);z=z.parentNode}else{if(A==z.length){A=w.getNodeIndex(z)+1;z=z.parentNode}else{y=w.splitDataNode(z,A)}}}if(!y){y=z.cloneNode(false);if(y.id){y.removeAttribute("id")}var C;while((C=z.childNodes[A])){g.debug("Moving node "+w.inspectNode(C)+" into "+w.inspectNode(y));y.appendChild(C)}w.insertAfter(y,z)}return(z==B)?y:r(B,y.parentNode,w.getNodeIndex(y))}function x(z,y){return z.tagName==y.tagName&&t(z,y)&&d(z,y)}function n(A,y){var C=(A.nodeType==3);var z=C?A.parentNode:A;var D;var B=y?"nextSibling":"previousSibling";if(C){D=A[B];if(D&&D.nodeType==3){return D}}else{D=z[B];if(D&&x(A,D)){return D[y?"firstChild":"lastChild"]}}return null}function m(y){this.isElementMerge=(y.nodeType==1);this.firstTextNode=this.isElementMerge?y.lastChild:y;if(this.isElementMerge){this.sortedCssClasses=i(y)}this.textNodes=[this.firstTextNode]}m.prototype={doMerge:function(){var D=[],C,A,B;for(var z=0,y=this.textNodes.length;z<y;++z){C=this.textNodes[z];A=C.parentNode;D[z]=C.data;if(z){A.removeChild(C);if(!A.hasChildNodes()){A.parentNode.removeChild(A)}}}this.firstTextNode.data=B=D.join("");return B},getLength:function(){var z=this.textNodes.length,y=0;while(z--){y+=this.textNodes[z].length}return y},toString:function(){var A=[];for(var z=0,y=this.textNodes.length;z<y;++z){A[z]="'"+this.textNodes[z].data+"'"}return"[Merge("+A.join(",")+")]"}};function q(z,y){this.name=z;if(typeof y=="object"){for(var A in y){if(y.hasOwnProperty(A)){this[A]=y[A]}}}}q.prototype={type:k,normalize:true,applyToAnyTagName:true,tagNames:["span"],postApply:function(K,G){g.group("postApply");var y=K[0],z=K[K.length-1];var B=[],L;var D=y,A=z;var I=0,M=z.length;var C,F;for(var E=0,H=K.length;E<H;++E){C=K[E];F=n(C,false);g.debug("Checking for merge. text node: "+C.data+", preceding: "+(F?F.data:null));if(F){if(!L){L=new m(F);B.push(L)}L.textNodes.push(C);if(C===y){D=L.firstTextNode;I=D.length}if(C===z){A=L.firstTextNode;M=L.getLength()}}else{L=null}}var J=n(z,true);if(J){if(!L){L=new m(z);B.push(L)}L.textNodes.push(J)}if(B.length){g.info("Merging. Merges:",B);for(E=0,H=B.length;E<H;++E){B[E].doMerge()}g.info(D.nodeValue,I,A.nodeValue,M);G.setStart(D,I);G.setEnd(A,M)}g.groupEnd()},getAppliedAncestor:function(z){var y=z.parentNode;while(y){if(y.nodeType==1&&w.arrayContains(this.tagNames,y.tagName.toLowerCase())&&this.isAppliedToElement(y)){return y}y=y.parentNode}return false},applyToElement:function(y){},unapplyToElement:function(y){},createContainer:function(z){var y=z.createElement(c);this.applyToElement(y);return y},applyToTextNode:function(A){var z=A.parentNode;if(z.childNodes.length==1&&w.arrayContains(this.tagNames,z.tagName.toLowerCase())){this.applyToElement(z)}else{var y=this.createContainer(w.getDocument(A));if(y){A.parentNode.insertBefore(y,A);y.appendChild(A)}}},isRemovable:function(y){return y.tagName.toLowerCase()==c&&u(y.className)==this.cssClass&&!f(y)},undoToTextNode:function(B,A,z){g.info("undoToTextNode",w.inspectNode(B),A.inspect(),w.inspectNode(z),A.containsNode(z));if(!A.containsNode(z)){var y=A.cloneRange();y.selectNode(z);g.info("range end in ancestor "+y.isPointInRange(A.endContainer,A.endOffset)+", isSplitPoint "+v(A.endContainer,A.endOffset));if(y.isPointInRange(A.endContainer,A.endOffset)&&v(A.endContainer,A.endOffset)){r(z,A.endContainer,A.endOffset);A.setEndAfter(z)}if(y.isPointInRange(A.startContainer,A.startOffset)&&v(A.startContainer,A.startOffset)){z=r(z,A.startContainer,A.startOffset)}}g.info("isRemovable",this.isRemovable(z),w.inspectNode(z),z.innerHTML,z.parentNode.innerHTML);if(this.isRemovable(z)){e(z)}else{this.unapplyToElement(z)}},applyToRange:function(z){z.splitBoundaries();g.info("applyToRange split boundaries ");var B=z.getNodes([3]);g.info("applyToRange got text nodes "+B);if(B.length){var C;for(var A=0,y=B.length;A<y;++A){C=B[A];if(!this.getAppliedAncestor(C)){this.applyToTextNode(C)}}z.setStart(B[0],0);C=B[B.length-1];z.setEnd(C,C.length);g.info("Apply set range to '"+B[0].data+"', '"+C.data+"'");if(this.normalize){this.postApply(B,z)}}},applyToSelection:function(C){g.group("applyToSelection");C=C||window;var B=p.getSelection(C);g.info("applyToSelection "+B.inspect());var z,y=B.getAllRanges();B.removeAllRanges();var A=y.length;while(A--){z=y[A];this.applyToRange(z);B.addRange(z)}g.groupEnd()},undoToRange:function(A){g.info("undoToRange "+A.inspect());A.splitBoundaries();var C=A.getNodes([3]),D,z;if(C.length){for(var B=0,y=C.length;B<y;++B){D=C[B];z=this.getAppliedAncestor(D);if(z){this.undoToTextNode(D,A,z)}}A.setStart(C[0],0);D=C[C.length-1];A.setEnd(D,D.length);g.info("Undo set range to '"+C[0].data+"', '"+D.data+"'");if(this.normalize){this.postApply(C,A)}}},undoToSelection:function(D){D=D||window;var C=p.getSelection(D);var z=C.getAllRanges(),A;C.removeAllRanges();for(var B=0,y=z.length;B<y;++B){A=z[B];this.undoToRange(A);C.addRange(A)}},getTextSelectedByRange:function(C,y){var z=y.cloneRange();z.selectNodeContents(C);var A=z.intersection(y);var B=A?A.toString():"";z.detach();return B},isAppliedToElement:function(y){return false},isAppliedToRange:function(z){var B=z.getNodes([3]);for(var A=0,y=B.length,C;A<y;++A){C=this.getTextSelectedByRange(B[A],z);g.debug("text node: '"+B[A].data+"', selectedText: '"+C+"'",this.isAppliedToElement(B[A].parentNode));if(C!=""&&!this.isAppliedToElement(B[A].parentNode)){return false}}return true},isAppliedToSelection:function(B){B=B||window;var A=p.getSelection(B);var y=A.getAllRanges();var z=y.length;while(z--){if(!this.isAppliedToRange(y[z])){return false}}g.groupEnd();return true},toggleRange:function(y){if(this.isAppliedToRange(y)){this.undoToRange(y)}else{this.applyToRange(y)}},toggleSelection:function(y){if(this.isAppliedToSelection(y)){this.undoToSelection(y)}else{this.applyToSelection(y)}},execSelection:function(A,z,y){if(this.type==k){this.toggleSelection(A)}},querySelectionValue:function(y){if(this.type==k){return this.isAppliedToSelection(y)}}};var l={};p.registerTextCommand=function(z,y){var A=new q(z,y);l[z.toLowerCase()]=A;return A};p.execSelectionCommand=function(z,C,B,y){var A=l[z.toLowerCase()];if(A&&A instanceof q){A.execSelection(C,B,y)}};p.querySelectionCommandValue=function(y,A){var z=l[y.toLowerCase()];if(z&&z instanceof q){return z.querySelectionValue(A)}};var h;if(typeof window.getComputedStyle!=s){h=function(y,z){return w.getWindow(y).getComputedStyle(y,null)[z]}}else{if(typeof w.getBody(document).currentStyle!=s){h=function(y,z){return y.currentStyle[z]}}else{b.fail("No means of obtaining computed style properties found")}}p.registerTextCommand("bold",{type:k,tagNames:["b","span","strong"],isAppliedToElement:function(A){var y=h(A,"fontWeight");var z=false;if(y=="bold"||y=="bolder"){z=true}else{if(y=="normal"||y=="lighter"){z=false}else{var B=parseInt(""+y);if(!isNaN(B)){z=B>400}}}return z},applyToElement:function(y){y.style.fontWeight="bold"},unapplyToElement:function(y){y.style.fontWeight="normal"}})});